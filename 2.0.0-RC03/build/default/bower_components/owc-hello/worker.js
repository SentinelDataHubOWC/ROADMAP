var TIFFPATH="/tiffs",initialized=!1,GDALOpen,GDALClose,GDALGetRasterCount,GDALGetRasterXSize,GDALGetRasterYSize,GDALGetProjectionRef,GDALGetGeoTransform,CPLQuietErrorHandler,CPLSetErrorHandler,CPLGetLastErrorMsg,CPLGetLastErrorNo,CPLGetLastErrorType,CPLErrorReset,Module={print:function(text){console.log("stdout: "+text)},printErr:function(text){console.log("stderr: "+text)},onRuntimeInitialized:function(){Module.ccall("GDALAllRegister",null,[],[]);GDALOpen=Module.cwrap("GDALOpen","number",["string"]);GDALClose=Module.cwrap("GDALClose",null,["number"]);CPLErrorReset=Module.cwrap("CPLErrorReset",null,[]);CPLSetErrorHandler=Module.cwrap("CPLSetErrorHandler","number",["number"]);CPLQuietErrorHandler=Module.cwrap("CPLQuietErrorHandler",null,["number","number","number"]);var cplQuietFnPtr=Runtime.addFunction(CPLQuietErrorHandler);CPLGetLastErrorNo=Module.cwrap("CPLGetLastErrorNo","number",[]);CPLGetLastErrorMsg=Module.cwrap("CPLGetLastErrorMsg","string",[]);CPLGetLastErrorType=Module.cwrap("CPLGetLastErrorType","number",[]);GDALGetRasterCount=Module.cwrap("GDALGetRasterCount","number",["number"]);GDALGetRasterXSize=Module.cwrap("GDALGetRasterXSize","number",["number"]);GDALGetRasterYSize=Module.cwrap("GDALGetRasterYSize","number",["number"]);GDALGetProjectionRef=Module.cwrap("GDALGetProjectionRef","string",["number"]);GDALGetGeoTransform=Module.cwrap("GDALGetGeoTransform","number",["number","number"]);CPLSetErrorHandler(cplQuietFnPtr);FS.mkdir(TIFFPATH);initialized=!0}};setTimeout(function(){Module.onRuntimeInitialized()},5e3);importScripts("gdal.js");function inspectTiff(files){console.warn("hello from worker.js inspectTiff()");console.log("files: ",files);console.log("FS: ",FS);console.log("WORKERFS: ",WORKERFS);console.log("TIFFPATH: ",TIFFPATH);setTimeout(function(){FS.mount(WORKERFS,{files:files},TIFFPATH);for(var results=[],i=0,dataset;i<files.length;i++){dataset=GDALOpen(TIFFPATH+"/"+files[i].name);console.warn("!!!!dataset: ",dataset);if(0!==CPLGetLastErrorNo()){console.log("Error occurred opening dataset");console.log("Error message: ",CPLGetLastErrorMsg());console.log("Error number: ",CPLGetLastErrorNo());console.log("Resetting errors");CPLErrorReset();continue}var bandCount=GDALGetRasterCount(dataset),maxX=GDALGetRasterXSize(dataset),maxY=GDALGetRasterYSize(dataset);wktStr=GDALGetProjectionRef(dataset);var byteOffset=Module._malloc(6*Float64Array.BYTES_PER_ELEMENT);GDALGetGeoTransform(dataset,byteOffset);var geoTransform=Module.HEAPF64.subarray(byteOffset/Float64Array.BYTES_PER_ELEMENT,byteOffset/Float64Array.BYTES_PER_ELEMENT+6),geoCorners=[[0,0],[maxX,0],[maxX,maxY],[0,maxY]].map(function(coords){var x=coords[0],y=coords[1];return[geoTransform[0]+geoTransform[1]*x+geoTransform[2]*y,geoTransform[3]+geoTransform[4]*x+geoTransform[5]*y]});results.push({bandCount:bandCount,xSize:maxX,ySize:maxY,projectionWkt:wktStr,coordinateTransform:geoTransform,corners:geoCorners});GDALClose(dataset)}postMessage(results);FS.unmount(TIFFPATH)},8e3);console.log("//////////////////////////TIFFPATH: ",TIFFPATH)}onmessage=function(msg){console.warn("hello from web worker");inspectTiff(msg.data);if(!initialized){console.log("Runtime not initialized yet, try again");return}inspectTiff(msg.data)};