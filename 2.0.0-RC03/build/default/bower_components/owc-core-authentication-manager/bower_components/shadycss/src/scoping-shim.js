"use strict";import{parse,StyleNode}from"./css-parse.js";import{nativeShadow,nativeCssVariables}from"./style-settings.js";import StyleTransformer from"./style-transformer.js";import*as StyleUtil from"./style-util.js";import StyleProperties from"./style-properties.js";import placeholderMap from"./style-placeholder.js";import StyleInfo from"./style-info.js";import StyleCache from"./style-cache.js";import{flush as watcherFlush}from"./document-watcher.js";import templateMap from"./template-map.js";import*as ApplyShimUtils from"./apply-shim-utils.js";import documentWait from"./document-wait.js";import{updateNativeProperties,detectMixin}from"./common-utils.js";import{CustomStyleInterfaceInterface}from"./custom-style-interface.js";const styleCache=new StyleCache;export default class ScopingShim{constructor(){this._scopeCounter={};this._documentOwner=document.documentElement;let ast=new StyleNode;ast.rules=[];this._documentOwnerStyleInfo=StyleInfo.set(this._documentOwner,new StyleInfo(ast));this._elementsHaveApplied=!1;this._applyShim=null;this._customStyleInterface=null;documentWait(()=>{this._ensure()})}flush(){watcherFlush()}_generateScopeSelector(name){let id=this._scopeCounter[name]=(this._scopeCounter[name]||0)+1;return`${name}-${id}`}getStyleAst(style){return StyleUtil.rulesForStyle(style)}styleAstToString(ast){return StyleUtil.toCssText(ast)}_gatherStyles(template){return StyleUtil.gatherStyleText(template.content)}_getCssBuild(template){let style=template.content.querySelector("style");if(!style){return""}return style.getAttribute("css-build")||""}prepareTemplate(template,elementName,typeExtension){if(template._prepared){return}template._prepared=!0;template.name=elementName;template.extends=typeExtension;templateMap[elementName]=template;let cssBuild=this._getCssBuild(template),cssText=this._gatherStyles(template);if(!nativeShadow){StyleTransformer.dom(template.content,elementName)}this._ensure();let hasMixins=detectMixin(cssText),ast=parse(cssText);if(hasMixins&&nativeCssVariables&&this._applyShim){this._applyShim.transformRules(ast,elementName)}template._styleAst=ast;template._cssBuild=cssBuild;let ownPropertyNames=[];if(!nativeCssVariables){ownPropertyNames=StyleProperties.decorateStyles(template._styleAst)}if(!ownPropertyNames.length||nativeCssVariables){let root=nativeShadow?template.content:null,placeholder=placeholderMap[elementName],style=this._generateStaticStyle({is:elementName,extends:typeExtension,__cssBuild:cssBuild},template._styleAst,root,placeholder);template._style=style}template._ownPropertyNames=ownPropertyNames}_generateStaticStyle(info,rules,shadowroot,placeholder){let cssText=StyleTransformer.elementStyles(info,rules);if(cssText.length){return StyleUtil.applyCss(cssText,info.is,shadowroot,placeholder)}}_prepareHost(host){let{is,typeExtension}=StyleUtil.getIsExtends(host),placeholder=placeholderMap[is],template=templateMap[is],ast,ownStylePropertyNames,cssBuild;if(template){ast=template._styleAst;ownStylePropertyNames=template._ownPropertyNames;cssBuild=template._cssBuild}return StyleInfo.set(host,new StyleInfo(ast,placeholder,ownStylePropertyNames,is,typeExtension,cssBuild))}_ensureApplyShim(){if(this._applyShim){}else if(window.ShadyCSS&&window.ShadyCSS.ApplyShim){this._applyShim=window.ShadyCSS.ApplyShim;this._applyShim.invalidCallback=ApplyShimUtils.invalidate}}_ensureCustomStyleInterface(){if(this._customStyleInterface){}else if(window.ShadyCSS&&window.ShadyCSS.CustomStyleInterface){this._customStyleInterface=window.ShadyCSS.CustomStyleInterface;this._customStyleInterface.transformCallback=style=>{this.transformCustomStyleForDocument(style)};this._customStyleInterface.validateCallback=()=>{requestAnimationFrame(()=>{if(this._customStyleInterface.enqueued||this._elementsHaveApplied){this.flushCustomStyles()}})}}}_ensure(){this._ensureApplyShim();this._ensureCustomStyleInterface()}flushCustomStyles(){this._ensure();if(!this._customStyleInterface){return}let customStyles=this._customStyleInterface.processStyles();if(!this._customStyleInterface.enqueued){return}if(!nativeCssVariables){this._updateProperties(this._documentOwner,this._documentOwnerStyleInfo);this._applyCustomStyles(customStyles)}else{this._revalidateCustomStyleApplyShim(customStyles)}this._customStyleInterface.enqueued=!1;if(this._elementsHaveApplied&&!nativeCssVariables){this.styleDocument()}}styleElement(host,overrideProps){let{is}=StyleUtil.getIsExtends(host),styleInfo=StyleInfo.get(host);if(!styleInfo){styleInfo=this._prepareHost(host)}if(!this._isRootOwner(host)){this._elementsHaveApplied=!0}if(overrideProps){styleInfo.overrideStyleProperties=styleInfo.overrideStyleProperties||{};Object.assign(styleInfo.overrideStyleProperties,overrideProps)}if(!nativeCssVariables){this._updateProperties(host,styleInfo);if(styleInfo.ownStylePropertyNames&&styleInfo.ownStylePropertyNames.length){this._applyStyleProperties(host,styleInfo)}}else{if(styleInfo.overrideStyleProperties){updateNativeProperties(host,styleInfo.overrideStyleProperties)}let template=templateMap[is];if(!template&&!this._isRootOwner(host)){return}if(template&&template._style&&!ApplyShimUtils.templateIsValid(template)){if(!ApplyShimUtils.templateIsValidating(template)){this._ensure();this._applyShim&&this._applyShim.transformRules(template._styleAst,is);template._style.textContent=StyleTransformer.elementStyles(host,styleInfo.styleRules);ApplyShimUtils.startValidatingTemplate(template)}if(nativeShadow){let root=host.shadowRoot;if(root){let style=root.querySelector("style");style.textContent=StyleTransformer.elementStyles(host,styleInfo.styleRules)}}styleInfo.styleRules=template._styleAst}}}_styleOwnerForNode(node){let root=node.getRootNode(),host=root.host;if(host){if(StyleInfo.get(host)){return host}else{return this._styleOwnerForNode(host)}}return this._documentOwner}_isRootOwner(node){return node===this._documentOwner}_applyStyleProperties(host,styleInfo){let is=StyleUtil.getIsExtends(host).is,cacheEntry=styleCache.fetch(is,styleInfo.styleProperties,styleInfo.ownStylePropertyNames),cachedScopeSelector=cacheEntry&&cacheEntry.scopeSelector,cachedStyle=cacheEntry?cacheEntry.styleElement:null,oldScopeSelector=styleInfo.scopeSelector;styleInfo.scopeSelector=cachedScopeSelector||this._generateScopeSelector(is);let style=StyleProperties.applyElementStyle(host,styleInfo.styleProperties,styleInfo.scopeSelector,cachedStyle);if(!nativeShadow){StyleProperties.applyElementScopeSelector(host,styleInfo.scopeSelector,oldScopeSelector)}if(!cacheEntry){styleCache.store(is,styleInfo.styleProperties,style,styleInfo.scopeSelector)}return style}_updateProperties(host,styleInfo){let owner=this._styleOwnerForNode(host),ownerStyleInfo=StyleInfo.get(owner),ownerProperties=ownerStyleInfo.styleProperties,props=Object.create(ownerProperties||null),hostAndRootProps=StyleProperties.hostAndRootPropertiesForScope(host,styleInfo.styleRules),propertyData=StyleProperties.propertyDataFromStyles(ownerStyleInfo.styleRules,host),propertiesMatchingHost=propertyData.properties;Object.assign(props,hostAndRootProps.hostProps,propertiesMatchingHost,hostAndRootProps.rootProps);this._mixinOverrideStyles(props,styleInfo.overrideStyleProperties);StyleProperties.reify(props);styleInfo.styleProperties=props}_mixinOverrideStyles(props,overrides){for(let p in overrides){let v=overrides[p];if(v||0===v){props[p]=v}}}styleDocument(properties){this.styleSubtree(this._documentOwner,properties)}styleSubtree(host,properties){let root=host.shadowRoot;if(root||this._isRootOwner(host)){this.styleElement(host,properties)}let shadowChildren=root&&(root.children||root.childNodes);if(shadowChildren){for(let i=0,c;i<shadowChildren.length;i++){c=shadowChildren[i];this.styleSubtree(c)}}else{let children=host.children||host.childNodes;if(children){for(let i=0,c;i<children.length;i++){c=children[i];this.styleSubtree(c)}}}}_revalidateCustomStyleApplyShim(customStyles){for(let i=0;i<customStyles.length;i++){let c=customStyles[i],s=this._customStyleInterface.getStyleForCustomStyle(c);if(s){this._revalidateApplyShim(s)}}}_applyCustomStyles(customStyles){for(let i=0;i<customStyles.length;i++){let c=customStyles[i],s=this._customStyleInterface.getStyleForCustomStyle(c);if(s){StyleProperties.applyCustomStyle(s,this._documentOwnerStyleInfo.styleProperties)}}}transformCustomStyleForDocument(style){let ast=StyleUtil.rulesForStyle(style);StyleUtil.forEachRule(ast,rule=>{if(nativeShadow){StyleTransformer.normalizeRootSelector(rule)}else{StyleTransformer.documentRule(rule)}if(nativeCssVariables){this._ensure();this._applyShim&&this._applyShim.transformRule(rule)}});if(nativeCssVariables){style.textContent=StyleUtil.toCssText(ast)}else{this._documentOwnerStyleInfo.styleRules.rules.push(ast)}}_revalidateApplyShim(style){if(nativeCssVariables&&this._applyShim){let ast=StyleUtil.rulesForStyle(style);this._ensure();this._applyShim.transformRules(ast);style.textContent=StyleUtil.toCssText(ast)}}getComputedStyleValue(element,property){let value;if(!nativeCssVariables){let styleInfo=StyleInfo.get(element)||StyleInfo.get(this._styleOwnerForNode(element));value=styleInfo.styleProperties[property]}value=value||window.getComputedStyle(element).getPropertyValue(property);return value?value.trim():""}setElementClass(element,classString){let root=element.getRootNode(),classes=classString?classString.split(/\s/):[],scopeName=root.host&&root.host.localName;if(!scopeName){var classAttr=element.getAttribute("class");if(classAttr){let k$=classAttr.split(/\s/);for(let i=0;i<k$.length;i++){if(k$[i]===StyleTransformer.SCOPE_NAME){scopeName=k$[i+1];break}}}}if(scopeName){classes.push(StyleTransformer.SCOPE_NAME,scopeName)}if(!nativeCssVariables){let styleInfo=StyleInfo.get(element);if(styleInfo&&styleInfo.scopeSelector){classes.push(StyleProperties.XSCOPE_NAME,styleInfo.scopeSelector)}}StyleUtil.setElementClassRaw(element,classes.join(" "))}_styleInfoForNode(node){return StyleInfo.get(node)}}ScopingShim.prototype.flush=ScopingShim.prototype.flush;ScopingShim.prototype.prepareTemplate=ScopingShim.prototype.prepareTemplate;ScopingShim.prototype.styleElement=ScopingShim.prototype.styleElement;ScopingShim.prototype.styleDocument=ScopingShim.prototype.styleDocument;ScopingShim.prototype.styleSubtree=ScopingShim.prototype.styleSubtree;ScopingShim.prototype.getComputedStyleValue=ScopingShim.prototype.getComputedStyleValue;ScopingShim.prototype.setElementClass=ScopingShim.prototype.setElementClass;ScopingShim.prototype._styleInfoForNode=ScopingShim.prototype._styleInfoForNode;ScopingShim.prototype.transformCustomStyleForDocument=ScopingShim.prototype.transformCustomStyleForDocument;ScopingShim.prototype.getStyleAst=ScopingShim.prototype.getStyleAst;ScopingShim.prototype.styleAstToString=ScopingShim.prototype.styleAstToString;ScopingShim.prototype.flushCustomStyles=ScopingShim.prototype.flushCustomStyles;Object.defineProperties(ScopingShim.prototype,{nativeShadow:{get(){return nativeShadow}},nativeCss:{get(){return nativeCssVariables}}});