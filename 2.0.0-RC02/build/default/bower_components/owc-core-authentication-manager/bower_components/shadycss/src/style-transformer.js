'use strict';import{StyleNode}from'./css-parse.js';import*as StyleUtil from'./style-util.js';import{nativeShadow}from'./style-settings.js';const SCOPE_NAME='style-scope';class StyleTransformer{get SCOPE_NAME(){return SCOPE_NAME}dom(a,b,d){a.__styleScoped?a.__styleScoped=null:this._transformDom(a,b||'',d)}_transformDom(a,b,d){a.nodeType===Node.ELEMENT_NODE&&this.element(a,b,d);let e='template'===a.localName?(a.content||a._content).childNodes:a.children||a.childNodes;if(e)for(let f=0;f<e.length;f++)this._transformDom(e[f],b,d)}element(a,b,d){if(b)if(a.classList)d?(a.classList.remove(SCOPE_NAME),a.classList.remove(b)):(a.classList.add(SCOPE_NAME),a.classList.add(b));else if(a.getAttribute){let e=a.getAttribute(CLASS);if(!d){let f=(e?e+' ':'')+SCOPE_NAME+' '+b;StyleUtil.setElementClassRaw(a,f)}else if(e){let f=e.replace(SCOPE_NAME,'').replace(b,'');StyleUtil.setElementClassRaw(a,f)}}}elementStyles(a,b,d){let e=a.__cssBuild,f='';if(nativeShadow||'shady'===e)f=StyleUtil.toCssText(b,d);else{let{is:g,typeExtension:h}=StyleUtil.getIsExtends(a);f=this.css(b,g,h,d)+'\n\n'}return f.trim()}css(a,b,d,e){let f=this._calcHostScope(b,d);b=this._calcElementScope(b);let g=this;return StyleUtil.toCssText(a,function(h){h.isScoped||(g.rule(h,b,f),h.isScoped=!0),e&&e(h,b,f)})}_calcElementScope(a){return a?CSS_CLASS_PREFIX+a:''}_calcHostScope(a,b){return b?`[is=${a}]`:a}rule(a,b,d){this._transformRule(a,this._transformComplexSelector,b,d)}_transformRule(a,b,d,e){a.selector=a.transformedSelector=this._transformRuleCss(a,b,d,e)}_transformRuleCss(a,b,d,e){let f=a.selector.split(COMPLEX_SELECTOR_SEP);if(!StyleUtil.isKeyframesSelector(a))for(let j,g=0,h=f.length;g<h&&(j=f[g]);g++)f[g]=b.call(this,j,d,e);return f.join(COMPLEX_SELECTOR_SEP)}_twiddleNthPlus(a){return a.replace(NTH,(b,d,e)=>{return-1<e.indexOf('+')?e=e.replace(/\+/g,'___'):-1<e.indexOf('___')&&(e=e.replace(/___/g,'+')),`:${d}(${e})`})}_transformComplexSelector(a,b,d){let e=!1;a=a.trim();let f=NTH.test(a);return f&&(a=a.replace(NTH,(g,h,j)=>`:${h}(${j.replace(/\s/g,'')})`),a=this._twiddleNthPlus(a)),a=a.replace(SLOTTED_START,`${HOST} $1`),a=a.replace(SIMPLE_SELECTOR_SEP,(g,h,j)=>{if(!e){let k=this._transformCompoundSelector(j,h,b,d);e=e||k.stop,h=k.combinator,j=k.value}return h+j}),f&&(a=this._twiddleNthPlus(a)),a}_transformCompoundSelector(a,b,d,e){let f=a.indexOf(SLOTTED);0<=a.indexOf(HOST)?a=this._transformHostSelector(a,e):0!==f&&(a=d?this._transformSimpleSelector(a,d):a);let g=!1;0<=f&&(b='',g=!0);let h;return g&&(h=!0,g&&(a=a.replace(SLOTTED_PAREN,(j,k)=>` > ${k}`))),a=a.replace(DIR_PAREN,(j,k,n)=>`[dir="${n}"] ${k}, ${k}[dir="${n}"]`),{value:a,combinator:b,stop:h}}_transformSimpleSelector(a,b){let d=a.split(PSEUDO_PREFIX);return d[0]+=b,d.join(PSEUDO_PREFIX)}_transformHostSelector(a,b){let d=a.match(HOST_PAREN),e=d&&d[2].trim()||'';if(e){if(!e[0].match(SIMPLE_SELECTOR_PREFIX)){let f=e.split(SIMPLE_SELECTOR_PREFIX)[0];return f===b?e:SELECTOR_NO_MATCH}return a.replace(HOST_PAREN,function(f,g,h){return b+h})}return a.replace(HOST,b)}documentRule(a){a.selector=a.parsedSelector,this.normalizeRootSelector(a),this._transformRule(a,this._transformDocumentSelector)}normalizeRootSelector(a){a.selector===ROOT&&(a.selector='html')}_transformDocumentSelector(a){return a.match(SLOTTED)?this._transformComplexSelector(a,SCOPE_DOC_SELECTOR):this._transformSimpleSelector(a.trim(),SCOPE_DOC_SELECTOR)}}let NTH=/:(nth[-\w]+)\(([^)]+)\)/,SCOPE_DOC_SELECTOR=`:not(.${SCOPE_NAME})`,COMPLEX_SELECTOR_SEP=',',SIMPLE_SELECTOR_SEP=/(^|[\s>+~]+)((?:\[.+?\]|[^\s>+~=[])+)/g,SIMPLE_SELECTOR_PREFIX=/[[.:#*]/,HOST=':host',ROOT=':root',SLOTTED='::slotted',SLOTTED_START=/^(::slotted)/,HOST_PAREN=/(:host)(?:\(((?:\([^)(]*\)|[^)(]*)+?)\))/,SLOTTED_PAREN=/(?:::slotted)(?:\(((?:\([^)(]*\)|[^)(]*)+?)\))/,DIR_PAREN=/(.*):dir\((?:(ltr|rtl))\)/,CSS_CLASS_PREFIX='.',PSEUDO_PREFIX=':',CLASS='class',SELECTOR_NO_MATCH='should_not_match';export default new StyleTransformer;