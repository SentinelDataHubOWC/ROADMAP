'use strict';import{removeCustomPropAssignment,StyleNode}from'./css-parse.js';import{nativeShadow}from'./style-settings.js';import StyleTransformer from'./style-transformer.js';import*as StyleUtil from'./style-util.js';import*as RX from'./common-regex.js';import StyleInfo from'./style-info.js';const matchesSelector=function(a){const b=this.matches||this.matchesSelector||this.mozMatchesSelector||this.msMatchesSelector||this.oMatchesSelector||this.webkitMatchesSelector;return b&&b.call(this,a)},IS_IE=navigator.userAgent.match('Trident'),XSCOPE_NAME='x-scope';class StyleProperties{get XSCOPE_NAME(){return XSCOPE_NAME}decorateStyles(a){let b=this,d={},e=[],f=0;StyleUtil.forEachRule(a,function(h){b.decorateRule(h),h.index=f++,b.collectPropertiesInCssText(h.propertyInfo.cssText,d)},function(j){e.push(j)}),a._keyframes=e;let g=[];for(let h in d)g.push(h);return g}decorateRule(a){if(a.propertyInfo)return a.propertyInfo;let b={},d={},e=this.collectProperties(a,d);return e&&(b.properties=d,a.rules=null),b.cssText=this.collectCssText(a),a.propertyInfo=b,b}collectProperties(a,b){let d=a.propertyInfo;if(!d){let e,f=RX.VAR_ASSIGN,g=a.parsedCssText,h,j;for(;e=f.exec(g);)h=(e[2]||e[3]).trim(),('inherit'!==h||'unset'!==h)&&(b[e[1].trim()]=h),j=!0;return j}else if(d.properties)return Object.assign(b,d.properties),!0}collectCssText(a){return this.collectConsumingCssText(a.parsedCssText)}collectConsumingCssText(a){return a.replace(RX.BRACKETED,'').replace(RX.VAR_ASSIGN,'')}collectPropertiesInCssText(a,b){for(let d,e;d=RX.VAR_CONSUMED.exec(a);)e=d[1],':'!==d[2]&&(b[e]=!0)}reify(a){let b=Object.getOwnPropertyNames(a);for(let e,d=0;d<b.length;d++)e=b[d],a[e]=this.valueForProperty(a[e],a)}valueForProperty(a,b){if(a)if(0<=a.indexOf(';'))a=this.valueForProperties(a,b);else{let d=this;a=StyleUtil.processVariableAndFallback(a,function(f,g,h,j){if(!g)return f+j;let k=d.valueForProperty(b[g],b);return k&&'initial'!==k?'apply-shim-inherit'===k&&(k='inherit'):k=d.valueForProperty(b[h]||h,b)||h,f+(k||'')+j})}return a&&a.trim()||''}valueForProperties(a,b){let d=a.split(';');for(let f,g,e=0;e<d.length;e++)if(f=d[e]){if(RX.MIXIN_MATCH.lastIndex=0,g=RX.MIXIN_MATCH.exec(f),g)f=this.valueForProperty(b[g[1]],b);else{let h=f.indexOf(':');if(-1!==h){let j=f.substring(h);j=j.trim(),j=this.valueForProperty(j,b)||j,f=f.substring(0,h)+j}}d[e]=f&&f.lastIndexOf(';')===f.length-1?f.slice(0,-1):f||''}return d.join(';')}applyProperties(a,b){let d='';a.propertyInfo||this.decorateRule(a),a.propertyInfo.cssText&&(d=this.valueForProperties(a.propertyInfo.cssText,b)),a.cssText=d}applyKeyframeTransforms(a,b){let d=a.cssText,e=a.cssText;if(null==a.hasAnimations&&(a.hasAnimations=RX.ANIMATION_MATCH.test(d)),a.hasAnimations){let f;if(null==a.keyframeNamesToTransform)for(let g in a.keyframeNamesToTransform=[],b)f=b[g],e=f(d),d!==e&&(d=e,a.keyframeNamesToTransform.push(g));else{for(let g=0;g<a.keyframeNamesToTransform.length;++g)f=b[a.keyframeNamesToTransform[g]],d=f(d);e=d}}a.cssText=e}propertyDataFromStyles(a,b){let d={},e=this,f=[];return StyleUtil.forEachRule(a,function(g){g.propertyInfo||e.decorateRule(g);let h=g.transformedSelector||g.parsedSelector;b&&g.propertyInfo.properties&&h&&matchesSelector.call(b,h)&&(e.collectProperties(g,d),addToBitMask(g.index,f))},null,!0),{properties:d,key:f}}whenHostOrRootRule(a,b,d,e){if(b.propertyInfo||this.decorateRule(b),!!b.propertyInfo.properties){let{is:f,typeExtension:g}=StyleUtil.getIsExtends(a),h=f?StyleTransformer._calcHostScope(f,g):'html',j=b.parsedSelector,k=':host > *'===j||'html'===j,q=0===j.indexOf(':host')&&!k;if('shady'===d&&(k=j===h+' > *.'+h||-1!==j.indexOf('html'),q=!k&&0===j.indexOf(h)),'shadow'===d&&(k=':host > *'===j||'html'===j,q=q&&!k),k||q){let r=h;q&&(!b.transformedSelector&&(b.transformedSelector=StyleTransformer._transformRuleCss(b,StyleTransformer._transformComplexSelector,StyleTransformer._calcElementScope(f),h)),r=b.transformedSelector||h),e({selector:r,isHost:q,isRoot:k})}}}hostAndRootPropertiesForScope(a,b){let d={},e={},f=this,g=b&&b.__cssBuild;return StyleUtil.forEachRule(b,function(h){f.whenHostOrRootRule(a,h,g,function(j){let k=a._element||a;matchesSelector.call(k,j.selector)&&(j.isHost?f.collectProperties(h,d):f.collectProperties(h,e))})},null,!0),{rootProps:e,hostProps:d}}transformStyles(a,b,d){let e=this,{is:f,typeExtension:g}=StyleUtil.getIsExtends(a),h=StyleTransformer._calcHostScope(f,g),j=a.extends?'\\'+h.slice(0,-1)+'\\]':h,k=new RegExp(RX.HOST_PREFIX+j+RX.HOST_SUFFIX),q=StyleInfo.get(a).styleRules,r=this._elementKeyframeTransforms(a,q,d);return StyleTransformer.elementStyles(a,q,function(t){e.applyProperties(t,b),nativeShadow||StyleUtil.isKeyframesSelector(t)||!t.cssText||(e.applyKeyframeTransforms(t,r),e._scopeSelector(t,k,h,d))})}_elementKeyframeTransforms(a,b,d){let e=b._keyframes,f={};if(!nativeShadow&&e)for(let g=0,h=e[g];g<e.length;h=e[++g])this._scopeKeyframes(h,d),f[h.keyframesName]=this._keyframesRuleTransformer(h);return f}_keyframesRuleTransformer(a){return function(b){return b.replace(a.keyframesNameRx,a.transformedKeyframesName)}}_scopeKeyframes(a,b){a.keyframesNameRx=new RegExp(`\\b${a.keyframesName}(?!\\B|-)`,'g'),a.transformedKeyframesName=a.keyframesName+'-'+b,a.transformedSelector=a.transformedSelector||a.selector,a.selector=a.transformedSelector.replace(a.keyframesName,a.transformedKeyframesName)}_scopeSelector(a,b,d,e){a.transformedSelector=a.transformedSelector||a.selector;let f=a.transformedSelector,g='.'+e,h=f.split(',');for(let q,j=0,k=h.length;j<k&&(q=h[j]);j++)h[j]=q.match(b)?q.replace(d,g):g+' '+q;a.selector=h.join(',')}applyElementScopeSelector(a,b,d){let e=a.getAttribute('class')||'',f=e;d&&(f=e.replace(new RegExp('\\s*'+XSCOPE_NAME+'\\s*'+d+'\\s*','g'),' ')),f+=(f?' ':'')+XSCOPE_NAME+' '+b,e!==f&&StyleUtil.setElementClassRaw(a,f)}applyElementStyle(a,b,d,e){let f=e?e.textContent||'':this.transformStyles(a,b,d),g=StyleInfo.get(a),h=g.customStyle;return h&&!nativeShadow&&h!==e&&(h._useCount--,0>=h._useCount&&h.parentNode&&h.parentNode.removeChild(h)),nativeShadow?g.customStyle?(g.customStyle.textContent=f,e=g.customStyle):f&&(e=StyleUtil.applyCss(f,d,a.shadowRoot,g.placeholder)):e?!e.parentNode&&(IS_IE&&-1<f.indexOf('@media')&&(e.textContent=f),StyleUtil.applyStyle(e,null,g.placeholder)):f&&(e=StyleUtil.applyCss(f,d,null,g.placeholder)),e&&(e._useCount=e._useCount||0,g.customStyle!=e&&e._useCount++,g.customStyle=e),e}applyCustomStyle(a,b){let d=StyleUtil.rulesForStyle(a),e=this;a.textContent=StyleUtil.toCssText(d,function(f){let g=f.cssText=f.parsedCssText;f.propertyInfo&&f.propertyInfo.cssText&&(g=removeCustomPropAssignment(g),f.cssText=e.valueForProperties(g,b))})}}function addToBitMask(a,b){let d=parseInt(a/32,10);b[d]=(b[d]||0)|1<<a%32}export default new StyleProperties;